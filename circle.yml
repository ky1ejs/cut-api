machine:
  environment:
    PROJECT_NAME: cut-api-kylejm
    CLUSTER_NAME: cut-api
    CLOUDSDK_COMPUTE_ZONE: europe-west1-d
    GCLOUD_AUTH_JSON: ${HOME}/account-auth.json
  services:
    - docker
  ruby:
    version: 2.3.0

dependencies:
  pre:
    - |
      if [ $CIRCLE_BRANCH = 'master' ]; then
        docker build -t kylejm/cut-api:$CIRCLE_SHA1 -f Dockerfile.prod .
      fi

test:
  post:
    - |
      if [ $CIRCLE_BRANCH = 'master' ]; then
        docker run -d -p 3000:3000 -e "SECRET_KEY_BASE=abcd1234" kylejm/cut-api:$CIRCLE_SHA1; sleep 10
        docker ps
        docker ps -a
        curl --retry 10 --retry-delay 5 -v http://localhost:3000
      fi

deployment:
  prod:
    branch: master
    commands:
      - ./deploy.sh
